commit 92eccef279d966b2319f0802fa4b22b430a5f72b
Author: Billy Vong <billyvg@users.noreply.github.com>
Date:   Wed Jun 27 16:57:21 2018 -0700

    feat(ui): Require "project:write" to enable plugins (#8769)
    
    This requires `project:write` in order to enable/configure plugins in the
    "Project Plugins" view
    
    Fixes JAVASCRIPT-3TY

diff --git a/src/sentry/static/sentry/app/components/feature.jsx b/src/sentry/static/sentry/app/components/feature.jsx
index 11c9258366..e53b889b3c 100644
--- a/src/sentry/static/sentry/app/components/feature.jsx
+++ b/src/sentry/static/sentry/app/components/feature.jsx
@@ -19,13 +19,19 @@ class Feature extends React.Component {
     config: PropTypes.arrayOf(PropTypes.string),
 
     /**
-     * List of required feature tags
+     * List of required feature tags. Note we do not enforce uniqueness of tags anywhere.
+     * On the backend end, feature tags have a scope prefix string that is stripped out on the
+     * frontend (since feature tags are attached to a context object).
+     *
+     * Use `organization:` or `project:` prefix strings to specify a feature with context.
      */
     feature: PropTypes.arrayOf(PropTypes.string),
+
     /**
      * List of required access levels
      */
     access: PropTypes.arrayOf(PropTypes.string),
+
     /**
      * If children is a function then will be treated as a render prop and passed this object:
      * {
diff --git a/src/sentry/static/sentry/app/views/projectPlugins/projectPluginRow.jsx b/src/sentry/static/sentry/app/views/projectPlugins/projectPluginRow.jsx
index daad834bd5..afd81edff6 100644
--- a/src/sentry/static/sentry/app/views/projectPlugins/projectPluginRow.jsx
+++ b/src/sentry/static/sentry/app/views/projectPlugins/projectPluginRow.jsx
@@ -7,6 +7,7 @@ import styled, {css} from 'react-emotion';
 import {t} from 'app/locale';
 import DynamicWrapper from 'app/components/dynamicWrapper';
 import ExternalLink from 'app/components/externalLink';
+import Feature from 'app/components/feature';
 import PluginIcon from 'app/plugins/components/pluginIcon';
 import SentryTypes from 'app/proptypes';
 import Switch from 'app/components/switch';
@@ -32,37 +33,52 @@ class ProjectPluginRow extends React.PureComponent {
 
     let configureUrl = recreateRoute(id, this.props);
     return (
-      <Flex key={id} className={slug} flex="1" align="center">
-        <PluginInfo>
-          <StyledPluginIcon size={48} pluginId={id} />
-          <Flex justify="center" direction="column">
-            <PluginName>
-              {`${name} `}
-              <DynamicWrapper
-                value={<Version>{version ? `v${version}` : <em>{t('n/a')}</em>}</Version>}
-                fixed={<Version>v10</Version>}
+      <Feature access={['project:write']}>
+        {({hasAccess}) => {
+          const LinkOrSpan = hasAccess ? Link : 'span';
+
+          return (
+            <Flex key={id} className={slug} flex="1" align="center">
+              <PluginInfo>
+                <StyledPluginIcon size={48} pluginId={id} />
+                <Flex justify="center" direction="column">
+                  <PluginName>
+                    {`${name} `}
+                    <DynamicWrapper
+                      value={
+                        <Version>{version ? `v${version}` : <em>{t('n/a')}</em>}</Version>
+                      }
+                      fixed={<Version>v10</Version>}
+                    />
+                  </PluginName>
+                  <div>
+                    {author && (
+                      <ExternalLink css={grayText} href={author.url}>
+                        {author.name}
+                      </ExternalLink>
+                    )}
+                    {hasConfiguration && (
+                      <span>
+                        {' '}
+                        &middot;{' '}
+                        <LinkOrSpan css={grayText} to={configureUrl}>
+                          {t('Configure plugin')}
+                        </LinkOrSpan>
+                      </span>
+                    )}
+                  </div>
+                </Flex>
+              </PluginInfo>
+              <Switch
+                size="lg"
+                isDisabled={!hasAccess}
+                isActive={enabled}
+                toggle={this.handleChange}
               />
-            </PluginName>
-            <div>
-              {author && (
-                <ExternalLink css={grayText} href={author.url}>
-                  {author.name}
-                </ExternalLink>
-              )}
-              {hasConfiguration && (
-                <span>
-                  {' '}
-                  &middot;{' '}
-                  <Link css={grayText} to={configureUrl}>
-                    {t('Configure plugin')}
-                  </Link>
-                </span>
-              )}
-            </div>
-          </Flex>
-        </PluginInfo>
-        <Switch size="lg" isActive={enabled} toggle={this.handleChange} />
-      </Flex>
+            </Flex>
+          );
+        }}
+      </Feature>
     );
   }
 }
diff --git a/tests/js/spec/views/projectPlugins/__snapshots__/projectPluginsRow.spec.jsx.snap b/tests/js/spec/views/projectPlugins/__snapshots__/projectPluginsRow.spec.jsx.snap
index 5fcb525578..86e0b8ba73 100644
--- a/tests/js/spec/views/projectPlugins/__snapshots__/projectPluginsRow.spec.jsx.snap
+++ b/tests/js/spec/views/projectPlugins/__snapshots__/projectPluginsRow.spec.jsx.snap
@@ -1,65 +1,212 @@
 // Jest Snapshot v1, https://goo.gl/fbAQLP
 
 exports[`ProjectPluginRow renders 1`] = `
-<Flex
-  align="center"
-  className="amazon-sqs"
-  flex="1"
-  key="amazon-sqs"
+<ProjectPluginRow
+  assets={Array []}
+  author={
+    Object {
+      "name": "Sentry Team",
+      "url": "https://github.com/getsentry/sentry",
+    }
+  }
+  canDisable={true}
+  enabled={false}
+  hasConfiguration={true}
+  id="amazon-sqs"
+  name="Amazon SQS"
+  orgId="org-slug"
+  projectId="project-slug"
+  slug="amazon-sqs"
+  version="8.23.0.dev0"
 >
-  <PluginInfo>
-    <StyledPluginIcon
-      pluginId="amazon-sqs"
-      size={48}
-    />
-    <Flex
-      direction="column"
-      justify="center"
+  <FeatureContainer
+    access={
+      Array [
+        "project:write",
+      ]
+    }
+  >
+    <Feature
+      access={
+        Array [
+          "project:write",
+        ]
+      }
+      config={Array []}
+      organization={
+        Object {
+          "access": Array [
+            "project:write",
+          ],
+          "features": Array [],
+          "id": "3",
+          "name": "Organization Name",
+          "onboardingTasks": Array [],
+          "projects": Array [],
+          "slug": "org-slug",
+          "status": Object {
+            "id": "active",
+            "name": "active",
+          },
+          "teams": Array [],
+        }
+      }
+      project={
+        Object {
+          "hasAccess": true,
+          "id": "2",
+          "isBookmarked": false,
+          "isMember": true,
+          "name": "Project Name",
+          "slug": "project-slug",
+          "teams": Array [],
+        }
+      }
     >
-      <PluginName>
-        Amazon SQS 
-        <DynamicWrapper
-          fixed={
-            <Version>
-              v10
-            </Version>
-          }
-          value={
-            <Version>
-              v8.23.0.dev0
-            </Version>
-          }
-        />
-      </PluginName>
-      <div>
-        <ExternalLink
-          className="css-8vm1xp-grayText"
-          href="https://github.com/getsentry/sentry"
-          rel="noreferrer noopener"
-          target="_blank"
+      <Flex
+        align="center"
+        className="amazon-sqs"
+        flex="1"
+        key="amazon-sqs"
+      >
+        <Base
+          align="center"
+          className="amazon-sqs css-1yrw3fm"
+          flex="1"
         >
-          Sentry Team
-        </ExternalLink>
-        <span>
-           
-          ·
-           
-          <Link
-            className="css-8vm1xp-grayText"
-            onlyActiveOnIndex={false}
-            style={Object {}}
-            to="amazon-sqs"
+          <div
+            className="amazon-sqs css-1yrw3fm"
+            is={null}
           >
-            Configure plugin
-          </Link>
-        </span>
-      </div>
-    </Flex>
-  </PluginInfo>
-  <Switch
-    isActive={false}
-    size="lg"
-    toggle={[Function]}
-  />
-</Flex>
+            <PluginInfo>
+              <div
+                className="css-sm2hu2-PluginInfo ectqpp0"
+              >
+                <StyledPluginIcon
+                  pluginId="amazon-sqs"
+                  size={48}
+                >
+                  <PluginIcon
+                    className="css-228l0j-StyledPluginIcon ectqpp2"
+                    pluginId="amazon-sqs"
+                    size={48}
+                  >
+                    <IntegrationIcon
+                      className="css-228l0j-StyledPluginIcon ectqpp2"
+                      image={Object {}}
+                      size={48}
+                    >
+                      <div
+                        className="ectqpp2 css-lxugym-IntegrationIcon-StyledPluginIcon e1bhjds90"
+                        size={48}
+                      />
+                    </IntegrationIcon>
+                  </PluginIcon>
+                </StyledPluginIcon>
+                <Flex
+                  direction="column"
+                  justify="center"
+                >
+                  <Base
+                    className="css-11zjqd3"
+                    direction="column"
+                    justify="center"
+                  >
+                    <div
+                      className="css-11zjqd3"
+                      is={null}
+                    >
+                      <PluginName>
+                        <div
+                          className="css-36lssg-PluginName ectqpp1"
+                        >
+                          Amazon SQS 
+                          <DynamicWrapper
+                            fixed={
+                              <Version>
+                                v10
+                              </Version>
+                            }
+                            value={
+                              <Version>
+                                v8.23.0.dev0
+                              </Version>
+                            }
+                          >
+                            <span>
+                              <Version>
+                                <span
+                                  className="css-1det7j8-Version ectqpp3"
+                                >
+                                  v8.23.0.dev0
+                                </span>
+                              </Version>
+                            </span>
+                          </DynamicWrapper>
+                        </div>
+                      </PluginName>
+                      <div>
+                        <ExternalLink
+                          className="css-8vm1xp-grayText"
+                          href="https://github.com/getsentry/sentry"
+                          rel="noreferrer noopener"
+                          target="_blank"
+                        >
+                          <a
+                            className="css-8vm1xp-grayText"
+                            href="https://github.com/getsentry/sentry"
+                            rel="noreferrer noopener"
+                            target="_blank"
+                          >
+                            Sentry Team
+                          </a>
+                        </ExternalLink>
+                        <span>
+                           
+                          ·
+                           
+                          <Link
+                            className="css-8vm1xp-grayText"
+                            onlyActiveOnIndex={false}
+                            style={Object {}}
+                            to="amazon-sqs"
+                          >
+                            <a
+                              className="css-8vm1xp-grayText"
+                              onClick={[Function]}
+                              style={Object {}}
+                            >
+                              Configure plugin
+                            </a>
+                          </Link>
+                        </span>
+                      </div>
+                    </div>
+                  </Base>
+                </Flex>
+              </div>
+            </PluginInfo>
+            <Switch
+              isActive={false}
+              isDisabled={false}
+              size="lg"
+              toggle={[Function]}
+            >
+              <div
+                aria-checked={false}
+                className="switch switch-lg"
+                onClick={[Function]}
+                role="checkbox"
+              >
+                <span
+                  className="switch-toggle"
+                />
+              </div>
+            </Switch>
+          </div>
+        </Base>
+      </Flex>
+    </Feature>
+  </FeatureContainer>
+</ProjectPluginRow>
 `;
diff --git a/tests/js/spec/views/projectPlugins/projectPluginsRow.spec.jsx b/tests/js/spec/views/projectPlugins/projectPluginsRow.spec.jsx
index 29ef7856b7..84611f806e 100644
--- a/tests/js/spec/views/projectPlugins/projectPluginsRow.spec.jsx
+++ b/tests/js/spec/views/projectPlugins/projectPluginsRow.spec.jsx
@@ -1,26 +1,42 @@
 import React from 'react';
-import {shallow, mount} from 'enzyme';
+import {mount} from 'enzyme';
 import ProjectPluginRow from 'app/views/projectPlugins/projectPluginRow';
 
 describe('ProjectPluginRow', function() {
   let wrapper;
   let plugin = TestStubs.Plugin();
-  let org = TestStubs.Organization();
+  let org = TestStubs.Organization({access: ['project:write']});
   let project = TestStubs.Project();
   let params = {orgId: org.slug, projectId: project.slug};
+  let routerContext = TestStubs.routerContext([{organization: org, project}]);
 
   it('renders', function() {
-    wrapper = shallow(<ProjectPluginRow {...params} {...plugin} />);
+    wrapper = mount(<ProjectPluginRow {...params} {...plugin} />, routerContext);
 
     expect(wrapper).toMatchSnapshot();
   });
 
   it('calls `onChange` when clicked', function() {
     let onChange = jest.fn();
-    wrapper = mount(<ProjectPluginRow {...params} {...plugin} onChange={onChange} />);
+    wrapper = mount(
+      <ProjectPluginRow {...params} {...plugin} onChange={onChange} />,
+      routerContext
+    );
 
     expect(onChange).not.toHaveBeenCalled();
     wrapper.find('Switch').simulate('click');
     expect(onChange).toHaveBeenCalledWith('amazon-sqs', true);
   });
+
+  it('can not enable/disable or configure plugin without `project:write`', function() {
+    let onChange = jest.fn();
+    wrapper = mount(
+      <ProjectPluginRow {...params} {...plugin} onChange={onChange} />,
+      TestStubs.routerContext([{organization: TestStubs.Organization({access: []})}])
+    );
+
+    expect(onChange).not.toHaveBeenCalled();
+    wrapper.find('Switch').simulate('click');
+    expect(onChange).not.toHaveBeenCalled();
+  });
 });
